<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geo Horror GO - Ultimate Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a1a2e">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* ================= GLOBAL & UI ================= */
html,body { margin:0; height:100%; background:#050505; font-family:'Segoe UI', Tahoma, sans-serif; overflow:hidden; color:white; user-select: none; -webkit-user-select: none; }
.leaflet-layer { filter: brightness(0.6) contrast(1.2) hue-rotate(200deg); }
#map { height: 100%; width: 100%; z-index: 1; }

/* HUD TOP */
.hud-top {
    position: fixed; top: 0; left: 0; right: 0; padding: 10px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
    z-index: 1000; display: flex; align-items: center; gap: 10px; pointer-events: none;
}
.player-avatar {
    width: 60px; height: 60px; background: #222; border: 2px solid #ffd700; border-radius: 50%; overflow: hidden; box-shadow: 0 0 10px #ffd700;
}
.player-avatar img { width: 100%; height: 100%; object-fit: cover; }
.stats-container { flex: 1; text-shadow: 1px 1px 2px black; }
.xp-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; margin-top: 4px; border: 1px solid #555; overflow: hidden; }
.xp-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00cc6a); width: 0%; transition: width 0.5s; }

/* HUD BOTTOM */
.hud-bottom {
    position: fixed; bottom: 20px; left: 0; right: 0;
    display: flex; justify-content: space-around; align-items: flex-end;
    padding: 0 10px; pointer-events: none; z-index: 1000;
}
.game-btn {
    pointer-events: auto; background: linear-gradient(145deg, #2a2a35, #1c1c25);
    border: 1px solid #444; color: #fff; border-radius: 50%; width: 60px; height: 60px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 10px; font-weight: bold;
}
.game-btn:active { transform: scale(0.95); }
.main-menu-btn { width: 75px; height: 75px; border-color: #ffd700; background: radial-gradient(circle, #e63946 0%, #901010 100%); }

/* GYM MARKERS */
.gym-marker-3d { pointer-events: auto; }
.gym-base {
    width: 60px; height: 60px; background: radial-gradient(circle, #444 30%, #111 90%);
    border-radius: 50%; transform: rotateX(60deg); border: 2px solid #888;
    box-shadow: 0 0 15px #ffffff; position: absolute; bottom: 0; left: -30px;
}
.gym-base.occupied { background: radial-gradient(circle, #ff4444 30%, #550000 90%); border-color: #ffaaaa; box-shadow: 0 0 15px #ff0000; }
.gym-defender {
    position: absolute; bottom: 15px; left: -30px; width: 60px; height: 60px; z-index: 10;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); animation: float 3s ease-in-out infinite;
}

/* MODALS */
.modal { position:fixed; inset:0; background:rgba(10,10,15,0.98); display:none; flex-direction:column; color:#fff; z-index:2000; backdrop-filter: blur(5px); }
.modal.active { display:flex; }
header { padding:15px; font-size:18px; font-weight:bold; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; background:#111; }
.modal-content { flex:1; overflow:auto; padding:15px; position:relative; }

/* ROSTER GRID */
.roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
.monster-card {
    background: #1c1c28; border: 1px solid #333; border-radius: 8px; padding: 5px;
    display: flex; flex-direction: column; align-items: center; text-align: center; font-size: 11px;
    position: relative; transition: background 0.2s;
}
.monster-card:active { background: #333; }
.monster-card img { width: 64px; height: 64px; }
.hp-bar-mini { width: 100%; height: 4px; background: #333; margin-top: 2px; }
.hp-fill-mini { height: 100%; background: #0f0; }

/* DETAIL VIEW */
.detail-view { display:none; flex-direction: column; align-items: center; text-align: center; height: 100%; }
.detail-view.active { display:flex; }
.detail-img { width: 150px; height: 150px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); }
.stat-row { display: flex; justify-content: space-between; width: 100%; max-width: 300px; margin: 5px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
.action-btn { width: 100%; max-width: 300px; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; font-weight: bold; font-size: 14px; cursor: pointer; }
.btn-power { background: #4CAF50; color: white; }
.btn-evolve { background: linear-gradient(45deg, #FFD700, #FFA500); color: black; }

/* CATCH SCREEN OVERLAY */
.catch-screen {
    position: fixed; inset: 0; background: radial-gradient(circle at center, #2a2a40, #000);
    z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center;
}
.catch-screen.active { display: flex; }
.wild-mon-container { position: relative; width: 200px; height: 200px; }
.wild-mon-img { width: 100%; height: 100%; image-rendering: pixelated; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); transition: transform 0.1s; }
.wild-mon-img:active { transform: scale(0.9) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } /* Hit effect */
.catch-ui { width: 80%; max-width: 400px; margin-top: 20px; text-align: center; }
.big-hp-bar { height: 20px; background: #333; border: 2px solid #fff; border-radius: 10px; overflow: hidden; margin-bottom: 10px; position:relative;}
.big-hp-text { position: absolute; width:100%; text-align: center; line-height: 20px; font-size: 12px; font-weight: bold; text-shadow: 1px 1px 1px #000; }
.big-hp-fill { height: 100%; background: #00ff00; transition: width 0.2s, background 0.2s; }
.catch-controls { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
.pokeball-btn { width: 80px; height: 80px; border-radius: 50%; background: white; border: 4px solid #333; position: relative; overflow: hidden; box-shadow: 0 5px 15px black; }
.pokeball-btn::after { content:''; position: absolute; bottom: 0; width: 100%; height: 50%; background: red; }
.pokeball-btn::before { content:''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; background: white; border: 4px solid #333; z-index: 2; border-radius: 50%; }

/* ANIMATIONS */
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
@keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
</style>
</head>
<body>

<div id="map"></div>

<!-- HUD -->
<div class="hud-top">
    <div class="player-avatar">
        <img src="https://img.pokemondb.net/sprites/heartgold-soulsilver/normal/pikachu.png" alt="Player">
    </div>
    <div class="stats-container">
        <div><b id="lvlDisplay">LVL 1</b> <span id="playerName">Ash</span></div>
        <div class="xp-bar-bg"><div class="xp-fill" id="xpFill"></div></div>
        <div style="font-size:11px; opacity:0.8; margin-top:2px;" id="statusText"></div>
    </div>
</div>

<div class="hud-bottom">
    <button class="game-btn" onclick="openRoster('view')">
        <span>üéí</span> Bag
    </button>
    <button class="game-btn main-menu-btn" onclick="createGym()">
        <span style="font-size:24px">üèüÔ∏è</span>
        <div style="margin-top:-5px">Build</div>
    </button>
    <button class="game-btn" onclick="alert('Shop:\nCoins: ' + state.coins + '\nUse coins in Bag to upgrade Pokemon!')">
        <span>üõí</span> Shop
    </button>
</div>

<!-- CATCH SCREEN -->
<div class="catch-screen" id="catchScreen">
    <div style="color: #fff; margin-bottom: 20px; text-align:center">
        <h2 id="catchName">Wild Pokemon</h2>
        <div style="font-size: 12px; opacity: 0.7;">Tap Pokemon to weaken!</div>
    </div>
    
    <div class="big-hp-bar" style="width: 200px;">
        <div class="big-hp-text" id="catchHpText">100/100</div>
        <div class="big-hp-fill" id="catchHpFill"></div>
    </div>

    <div class="wild-mon-container">
        <img id="catchImg" class="wild-mon-img" src="" onclick="tapDamage()">
    </div>

    <div class="catch-controls">
        <button class="game-btn" onclick="closeAll()">Run</button>
        <div style="text-align:center">
            <button class="pokeball-btn" onclick="throwBall()"></button>
            <div style="margin-top:5px; font-weight:bold;">x<span id="ballCountDisplay">0</span></div>
        </div>
    </div>
</div>

<!-- INVENTORY / SELECT MODAL -->
<div class="modal" id="rosterModal">
    <header>
        <button id="backBtn" style="visibility:hidden; background:transparent; border:none; color:white; font-size:20px" onclick="backToGrid()">‚ùÆ</button>
        <span id="rosterTitle">Pokemon</span> 
        <button style="background:transparent; border:none; color:white; font-size:24px" onclick="closeAll()">√ó</button>
    </header>
    
    <div class="modal-content">
        <!-- GRID VIEW -->
        <div id="rosterList" class="roster-grid"></div>
        
        <!-- DETAIL VIEW -->
        <div id="detailView" class="detail-view">
            <img id="detailImg" class="detail-img" src="">
            <h2 id="detailName">Name</h2>
            <div id="detailCp" style="color:#aaa; margin-bottom:15px">CP 100</div>
            
            <div class="stat-row">
                <span>HP</span>
                <span id="detailHp">100/100</span>
            </div>
            <div class="stat-row">
                <span>Attack</span>
                <span id="detailAtk">10</span>
            </div>
            <div class="stat-row">
                <span>Defense</span>
                <span id="detailDef">10</span>
            </div>

            <br>
            <div style="font-size:12px; color:#ffd700">Balance: <span id="walletDisp">0</span> Coins</div>

            <button class="action-btn btn-power" onclick="powerUp()">
                Power Up <br><span style="font-size:10px; opacity:0.8" id="powerCost">Cost: 100</span>
            </button>
            
            <button class="action-btn btn-evolve" onclick="evolve()">
                Evolve <br><span style="font-size:10px; opacity:0.8">Cost: 500 Coins</span>
            </button>
        </div>
    </div>
</div>

<script>
/* =========================
   POKEMON DATA
========================= */
const POKE_NAMES = [
"Bulbasaur","Ivysaur","Venusaur","Charmander","Charmeleon","Charizard","Squirtle","Wartortle","Blastoise","Caterpie","Metapod","Butterfree","Weedle","Kakuna","Beedrill","Pidgey","Pidgeotto","Pidgeot","Rattata","Raticate","Spearow","Fearow","Ekans","Arbok","Pikachu","Raichu","Sandshrew","Sandslash","Nidoran‚ôÄ","Nidorina","Nidoqueen","Nidoran‚ôÇ","Nidorino","Nidoking","Clefairy","Clefable","Vulpix","Ninetales","Jigglypuff","Wigglytuff","Zubat","Golbat","Oddish","Gloom","Vileplume","Paras","Parasect","Venonat","Venomoth","Diglett","Dugtrio","Meowth","Persian","Psyduck","Golduck","Mankey","Primeape","Growlithe","Arcanine","Poliwag","Poliwhirl","Poliwrath","Abra","Kadabra","Alakazam","Machop","Machoke","Machamp","Bellsprout","Weepinbell","Victreebel","Tentacool","Tentacruel","Geodude","Graveler","Golem","Ponyta","Rapidash","Slowpoke","Slowbro","Magnemite","Magneton","Farfetch'd","Doduo","Dodrio","Seel","Dewgong","Grimer","Muk","Shellder","Cloyster","Gastly","Haunter","Gengar","Onix","Drowzee","Hypno","Krabby","Kingler","Voltorb","Electrode","Exeggcute","Exeggutor","Cubone","Marowak","Hitmonlee","Hitmonchan","Lickitung","Koffing","Weezing","Rhyhorn","Rhydon","Chansey","Tangela","Kangaskhan","Horsea","Seadra","Goldeen","Seaking","Staryu","Starmie","Mr. Mime","Scyther","Jynx","Electabuzz","Magmar","Pinsir","Tauros","Magikarp","Gyarados","Lapras","Ditto","Eevee","Vaporeon","Jolteon","Flareon","Porygon","Omanyte","Omastar","Kabuto","Kabutops","Aerodactyl","Snorlax","Articuno","Zapdos","Moltres","Dratini","Dragonair","Dragonite","Mewtwo","Mew"
];

/* =========================
   GAME CONFIG & STATE
========================= */
const state = JSON.parse(localStorage.getItem('state')) || {
    xp: 0, level: 1, maxXp: 500,
    balls: 50, coins: 100, // Starting coins
    monsters: [],
    gyms: [], 
    pathSegments: {},
    lastLogin: null
};

// Runtime
let map, playerMarker, lastPos = null;
let pathLayerGroup = L.layerGroup();
let wildSpawnsLayer = L.layerGroup();
let activeWildMon = null; 
let selectedGymIndex = -1; 
let selectedMonIndex = -1;
let mode = 'view'; // 'view', 'select-defender', 'select-attacker'

/* =========================
   INIT
========================= */
window.addEventListener('load', () => {
    map = L.map('map', { zoomControl:false, attributionControl: false }).setView([0,0],18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);
    pathLayerGroup.addTo(map);
    wildSpawnsLayer.addTo(map);

    startGPS();
    drawGyms();
    updateHUD();
});

/* =========================
   GPS & MOVEMENT
========================= */
function startGPS(){
    navigator.geolocation.watchPosition(p => {
        const latlng = [p.coords.latitude, p.coords.longitude];
        
        if(!playerMarker) {
            const ashIcon = L.divIcon({
                className: 'player-icon',
                html: `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/ash.png" style="width:50px; height:80px; margin-top:-40px; margin-left:-25px; filter: drop-shadow(2px 4px 6px black);">`,
                iconSize: [0,0]
            });
            playerMarker = L.marker(latlng, {icon: ashIcon, zIndexOffset: 1000}).addTo(map);
            map.setView(latlng, 19);
        } else {
            playerMarker.setLatLng(latlng);
            map.panTo(latlng);
        }

        if(lastPos) processPath(lastPos, latlng);
        lastPos = latlng;

        // SPAWN LOGIC: 5% chance per update (Reduced from 15%)
        if(Math.random() > 0.95) attemptSpawn(latlng[0], latlng[1]);
    }, null, { enableHighAccuracy: true });
}

function processPath(p1, p2) {
    const k1 = p1.map(n=>n.toFixed(4)).join(','), k2 = p2.map(n=>n.toFixed(4)).join(',');
    const key = k1<k2 ? `${k1}-${k2}` : `${k2}-${k1}`;
    state.pathSegments[key] = (state.pathSegments[key]||0)+1;
    
    let color = '#00aaff';
    if(state.pathSegments[key]>2) color = '#aa00ff';
    if(state.pathSegments[key]>5) color = '#ff0000';

    L.polyline([p1, p2], { color: color, weight: 6, opacity: 0.7 }).addTo(pathLayerGroup);
}

/* =========================
   RPG & SPAWN SYSTEM
========================= */
function getName(id) { return POKE_NAMES[id-1] || `Poke #${id}`; }

function attemptSpawn(lat, lng) {
    // Rarity Weights
    const roll = Math.random() * 100;
    let id;
    
    // 50% Common (Pidgey, Rattata, etc - IDs 10-25 approx)
    if (roll < 50) id = [10,13,16,19,21,23,41,43,46,48,52,54,60,63,66,69].sort(()=>Math.random()-.5)[0];
    // 35% Uncommon (Starters, Pikachu, etc)
    else if (roll < 85) id = [1,4,7,25,35,37,39,56,58,74,77,79,81,84,86,88,90,92,96,98,100,102,104,109,111,116,118,129].sort(()=>Math.random()-.5)[0];
    // 14% Rare (Snorlax, Lapras, Evolutions)
    else if (roll < 99) id = [3,6,9,143,131,134,135,136,149,142,123,127,125,126].sort(()=>Math.random()-.5)[0];
    // 1% Legendary
    else id = [144,145,146,150,151].sort(()=>Math.random()-.5)[0];

    const level = Math.max(1, state.level + Math.floor(Math.random()*4) - 2);
    spawnMonster(lat, lng, id, level);
}

function spawnMonster(lat, lng, id, level) {
    const hp = 20 + (level * 15);
    const mon = {
        uuid: Date.now() + Math.random(),
        id: id,
        name: getName(id),
        level: level,
        xp: 0, maxXp: level * 100,
        hp: hp, maxHp: hp,
        atk: 5 + (level * 3),
        def: 5 + (level * 3),
        cp: level * 25
    };

    const loc = [lat + (Math.random()-.5)*.0008, lng + (Math.random()-.5)*.0008];
    const icon = L.divIcon({
        className: 'wild-spawn',
        html: `<img src="${sprite(mon.id)}" style="width:60px; height:60px; filter:drop-shadow(0 0 5px gold); animation:popIn 0.3s">`,
        iconSize: [60,60], iconAnchor: [30,30]
    });

    const m = L.marker(loc, {icon: icon}).addTo(wildSpawnsLayer);
    m.on('click', () => startCatch(mon, m));

    setTimeout(() => wildSpawnsLayer.removeLayer(m), 90000); // 1.5 min despawn
}

/* =========================
   CATCH LOGIC
========================= */
function startCatch(mon, markerLayer) {
    activeWildMon = JSON.parse(JSON.stringify(mon)); 
    activeWildMon.marker = markerLayer;
    
    document.getElementById('catchImg').src = sprite(activeWildMon.id);
    document.getElementById('catchName').innerText = `${activeWildMon.name} (Lvl ${activeWildMon.level})`;
    document.getElementById('ballCountDisplay').innerText = state.balls;
    updateCatchUI();
    document.getElementById('catchScreen').classList.add('active');
}

function tapDamage() {
    const dmg = Math.max(1, Math.floor(activeWildMon.maxHp * 0.05));
    activeWildMon.hp = Math.max(1, activeWildMon.hp - dmg); 
    
    const img = document.getElementById('catchImg');
    img.style.animation = 'none'; img.offsetHeight; img.style.animation = 'shake 0.3s';
    updateCatchUI();
}

function updateCatchUI() {
    const pct = (activeWildMon.hp / activeWildMon.maxHp) * 100;
    const bar = document.getElementById('catchHpFill');
    document.getElementById('catchHpText').innerText = `${activeWildMon.hp}/${activeWildMon.maxHp}`;
    bar.style.width = pct + "%";
    bar.style.background = pct > 50 ? '#0f0' : pct > 20 ? '#ff0' : '#f00';
}

function throwBall() {
    if(state.balls <= 0) return alert("Out of Balls!");
    state.balls--;
    updateHUD();
    document.getElementById('ballCountDisplay').innerText = state.balls;

    const hpPct = activeWildMon.hp / activeWildMon.maxHp;
    const catchChance = hpPct < 0.20 ? 0.60 : 0.30;

    if(Math.random() < catchChance) {
        alert(`Caught ${activeWildMon.name}! +100XP, +5 Coins`);
        state.monsters.push(activeWildMon);
        state.coins += 5;
        addXp(100);
        wildSpawnsLayer.removeLayer(activeWildMon.marker);
        closeAll();
        save();
    } else {
        alert("Broke free!");
        if(Math.random() > 0.7) {
            alert("It fled!");
            wildSpawnsLayer.removeLayer(activeWildMon.marker);
            closeAll();
        }
    }
}

/* =========================
   GYM & BATTLE
========================= */
function createGym() {
    if(state.gyms.length >= 5) return alert("Max Gyms built.");
    navigator.geolocation.getCurrentPosition(p => {
        state.gyms.push({ lat: p.coords.latitude, lng: p.coords.longitude, defender: null, lastSpin: 0 });
        drawGyms();
        save();
    });
}

function drawGyms() {
    map.eachLayer(l => { if(l.options.isGym) map.removeLayer(l); });
    state.gyms.forEach((g, index) => {
        const isOcc = g.defender != null;
        const html = `
            <div class="gym-base ${isOcc?'occupied':''}"></div>
            ${isOcc ? `<img class="gym-defender" src="${sprite(g.defender.id)}">` : ''}
        `;
        const icon = L.divIcon({ className: 'gym-marker-3d', html: html, iconSize:[0,0] });
        const m = L.marker([g.lat, g.lng], {icon: icon, isGym: true}).addTo(map);
        m.on('click', () => interactGym(index));
    });
}

function interactGym(index) {
    selectedGymIndex = index;
    const gym = state.gyms[index];
    const now = Date.now();

    if(now - gym.lastSpin > 300000) { 
        gym.lastSpin = now;
        state.balls += 5;
        state.coins += 10;
        addXp(25);
        alert("GYM SPUN! +5 Balls, +10 Coins, +25 XP");
        save();
    } else {
        const mins = Math.ceil((300000 - (now - gym.lastSpin))/60000);
        alert(`Spin cooldown: ${mins} min(s).`);
    }

    if(!gym.defender) {
        if(confirm("Place a defender?")) { mode = 'select-defender'; openRoster('select-defender'); }
    } else {
        if(confirm(`Challenge ${gym.defender.name}?`)) { mode = 'select-attacker'; openRoster('select-attacker'); }
    }
}

function handleRosterClick(monIndex) {
    const mon = state.monsters[monIndex];

    if(mode === 'view') {
        // Open Detail View
        selectedMonIndex = monIndex;
        openDetailView(mon);
    } 
    else if(mode === 'select-defender') {
        state.gyms[selectedGymIndex].defender = mon;
        state.monsters.splice(monIndex, 1);
        drawGyms(); closeAll(); save();
    } 
    else if (mode === 'select-attacker') {
        closeAll();
        resolveBattle(mon, state.gyms[selectedGymIndex].defender);
    }
}

function resolveBattle(attacker, defender) {
    const attPower = attacker.atk * (attacker.hp/attacker.maxHp) * Math.random();
    const defPower = defender.def * (defender.hp/defender.maxHp) * Math.random();

    if(attPower > defPower) {
        alert(`VICTORY! ${defender.name} returned to owner.`);
        addXp(150);
        defender.hp = 1; 
        state.monsters.push(defender);
        state.gyms[selectedGymIndex].defender = null;
        drawGyms(); save();
    } else {
        alert(`DEFEAT! ${defender.name} held the gym.`);
        defender.xp += 50; // Simple leveling logic for defender could be added here
        attacker.hp = Math.max(1, attacker.hp - 20);
        save();
    }
}

/* =========================
   INVENTORY DETAILS (POWER UP/EVOLVE)
========================= */
function openDetailView(mon) {
    document.getElementById('rosterList').style.display = 'none';
    document.getElementById('detailView').classList.add('active');
    document.getElementById('backBtn').style.visibility = 'visible';
    document.getElementById('rosterTitle').innerText = "Manage Pokemon";

    renderDetail(mon);
}

function renderDetail(mon) {
    document.getElementById('detailImg').src = sprite(mon.id);
    document.getElementById('detailName').innerText = mon.name;
    document.getElementById('detailCp').innerText = `Lvl ${mon.level} | CP ${mon.cp}`;
    document.getElementById('detailHp').innerText = `${mon.hp}/${mon.maxHp}`;
    document.getElementById('detailAtk').innerText = mon.atk;
    document.getElementById('detailDef').innerText = mon.def;
    document.getElementById('walletDisp').innerText = state.coins;
    
    // Update Power Cost Text
    document.getElementById('powerCost').innerText = `Cost: ${mon.level * 100} Coins`;
}

function backToGrid() {
    document.getElementById('detailView').classList.remove('active');
    document.getElementById('rosterList').style.display = 'grid';
    document.getElementById('backBtn').style.visibility = 'hidden';
    document.getElementById('rosterTitle').innerText = mode === 'view' ? 'Inventory' : 'Select Pokemon';
}

function powerUp() {
    const mon = state.monsters[selectedMonIndex];
    const cost = mon.level * 100;
    
    if(state.coins >= cost) {
        state.coins -= cost;
        mon.level++;
        mon.maxHp += 10; mon.hp = mon.maxHp;
        mon.atk += 3; mon.def += 3;
        mon.cp += 30;
        alert(`Powered up to Level ${mon.level}!`);
        renderDetail(mon);
        save();
    } else {
        alert("Not enough coins!");
    }
}

function evolve() {
    const mon = state.monsters[selectedMonIndex];
    const cost = 500;
    
    if(state.coins >= cost) {
        if(mon.id >= 151) return alert("Cannot evolve further!");
        state.coins -= cost;
        mon.id++;
        mon.name = getName(mon.id);
        mon.maxHp += 20; mon.hp = mon.maxHp;
        mon.atk += 5; mon.def += 5; mon.cp += 50;
        alert(`Evolved into ${mon.name}!`);
        renderDetail(mon);
        save();
    } else {
        alert("Not enough coins!");
    }
}

/* =========================
   UI HELPER
========================= */
function addXp(amt) {
    state.xp += amt;
    if(state.xp >= state.maxXp) {
        state.level++; state.xp -= state.maxXp; state.maxXp = Math.floor(state.maxXp * 1.5);
        state.balls += 10;
        alert(`LEVEL UP! ${state.level}`);
    }
    updateHUD();
}

function updateHUD() {
    document.getElementById('lvlDisplay').innerText = `LVL ${state.level}`;
    document.getElementById('statusText').innerText = `XP:${state.xp}/${state.maxXp} | Balls:${state.balls} | Coins:${state.coins}`;
    document.getElementById('xpFill').style.width = (state.xp/state.maxXp*100) + "%";
}

function openRoster(m) {
    mode = m;
    const list = document.getElementById('rosterList');
    document.getElementById('rosterTitle').innerText = mode === 'view' ? 'Inventory' : 'Select Pokemon';
    list.innerHTML = '';
    backToGrid(); // Reset to grid view
    
    if(state.monsters.length === 0) list.innerHTML = '<div style="color:gray; padding:20px;">No Pokemon caught yet.</div>';

    state.monsters.forEach((mon, i) => {
        const div = document.createElement('div');
        div.className = 'monster-card';
        div.onclick = () => handleRosterClick(i);
        
        const hpPct = (mon.hp / mon.maxHp) * 100;
        div.innerHTML = `
            <img src="${sprite(mon.id)}">
            <div><b>${mon.name}</b></div>
            <div style="font-size:9px">CP ${mon.cp}</div>
            <div class="hp-bar-mini"><div class="hp-fill-mini" style="width:${hpPct}%; background:${hpPct>50?'#0f0':'#f00'}"></div></div>
        `;
        list.appendChild(div);
    });
    show('rosterModal');
}

function sprite(id) { return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`; }
function show(id) { document.getElementById(id).classList.add('active'); }
function closeAll() { document.querySelectorAll('.modal, .catch-screen').forEach(m => m.classList.remove('active')); }
function save() { localStorage.setItem('state', JSON.stringify(state)); updateHUD(); }

</script>
</body>
</html>