<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geo Horror GO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0b0b0f">

<!-- Leaflet (lightweight, mobile-friendly) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    touch-action: manipulation;
}

#map {
    width: 100%;
    height: 100%;
}

/* Horror overlay */
.leaflet-container {
    filter: saturate(0.6) contrast(1.2) brightness(0.9);
}

.horror-sprite {
    filter: grayscale(0.3) contrast(1.4) brightness(0.8);
    position: relative;
}
.horror-sprite::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at bottom, rgba(180,0,0,0.35), transparent 60%);
    pointer-events: none;
}

/* HUD */
#hud {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(10,10,15,0.9);
    color: #fff;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    z-index: 999;
}

button {
    background: #1b1b24;
    color: #fff;
    border: 1px solid #333;
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 14px;
}
button:active {
    transform: scale(0.96);
}

/* Loading screen */
#loading {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle, #120015, #000);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f55;
    font-size: 18px;
    z-index: 2000;
}
</style>
</head>
<body>

<div id="loading">Loading corrupted creaturesâ€¦</div>
<div id="map"></div>

<div id="hud">
    <button onclick="createGym()">Create GYM</button>
    <div id="status">XP: 0 | Coins: 0</div>
    <button onclick="openInventory()">Inventory</button>
</div>

<script>
/* ============================
   CORE GAME STATE
============================ */
const state = {
    xp: 0,
    coins: 0,
    path: [],
    gyms: JSON.parse(localStorage.getItem('gyms') || '[]'),
    monsters: [],
    items: {},
    joinedAt: Date.now()
};

/* ============================
   MAP INIT
============================ */
const map = L.map('map', {
    zoomControl: false,
    attributionControl: false
}).setView([0, 0], 18);

L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 20 }
).addTo(map);

/* ============================
   PLAYER
============================ */
let playerMarker;
let pathLine;

navigator.geolocation.watchPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];

    if (!playerMarker) {
        playerMarker = L.circleMarker(latlng, {
            radius: 10,
            color: '#ff4444',
            fillColor: '#ff0000',
            fillOpacity: 0.9
        }).addTo(map);
        map.setView(latlng, 19);
    } else {
        playerMarker.setLatLng(latlng);
    }

    recordPath(latlng);
    spawnCheck(latlng);
}, err => {
    alert('GPS required to play.');
}, {
    enableHighAccuracy: true,
    maximumAge: 1000
});

/* ============================
   PATH RECORDING (COLOR FADING)
============================ */
function recordPath(latlng) {
    state.path.push(latlng);

    if (state.path.length < 2) return;

    if (pathLine) map.removeLayer(pathLine);

    pathLine = L.polyline(state.path, {
        color: `hsl(${Math.min(state.path.length / 5, 360)}, 80%, 50%)`,
        weight: 6,
        opacity: 0.85
    }).addTo(map);
}

/* ============================
   SPIN STOPS
============================ */
function spawnSpinStop(latlng) {
    const marker = L.circleMarker(latlng, {
        radius: 14,
        color: '#44f',
        fillColor: '#2266ff',
        fillOpacity: 0.9
    }).addTo(map);

    marker.on('click', () => {
        const drops = Math.floor(Math.random() * 5) + 1;
        state.coins += drops;
        updateHUD();
        map.removeLayer(marker);
    });
}

/* ============================
   MONSTER SPAWNS
============================ */
async function spawnCheck(latlng) {
    if (Math.random() > 0.98) {
        const id = Math.floor(Math.random() * 151) + 1;
        const sprite = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

        const m = L.marker(latlng, {
            icon: L.icon({
                iconUrl: sprite,
                iconSize: [48,48],
                className: 'horror-sprite'
            })
        }).addTo(map);

        m.on('click', () => {
            state.monsters.push({ id, level: 1 });
            state.xp += 10;
            updateHUD();
            map.removeLayer(m);
        });
    }
}

/* ============================
   GYMS (LOCAL PERSISTENCE)
============================ */
function createGym() {
    if (state.gyms.length >= 3 || !playerMarker) return;

    const latlng = playerMarker.getLatLng();
    const gym = { latlng, defenders: [] };

    state.gyms.push(gym);
    localStorage.setItem('gyms', JSON.stringify(state.gyms));

    renderGyms();
}

function renderGyms() {
    state.gyms.forEach(g => {
        L.circle(g.latlng, {
            radius: 25,
            color: '#f00',
            fillOpacity: 0.3
        }).addTo(map);
    });
}
renderGyms();

/* ============================
   HUD
============================ */
function updateHUD() {
    document.getElementById('status').textContent =
        `XP: ${state.xp} | Coins: ${state.coins}`;
}
updateHUD();

/* ============================
   INVENTORY
============================ */
function openInventory() {
    alert(`Monsters: ${state.monsters.length}`);
}

/* ============================
   PRELOAD COMPLETE
============================ */
setTimeout(() => {
    document.getElementById('loading').style.display = 'none';
}, 1200);
</script>
</body>
</html>
